datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Forum: discussioni e risposte
model ForumThread {
  id        Int      @id @default(autoincrement())
  authorId  Int
  category  String // es: citta | esperienze | eventi | servizi
  title     String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User        @relation("ForumThreadsAuthored", fields: [authorId], references: [id])
  posts  ForumPost[]

  @@index([category, createdAt])
}

model ForumPost {
  id        Int      @id @default(autoincrement())
  threadId  Int
  authorId  Int
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  thread ForumThread @relation(fields: [threadId], references: [id])
  author User        @relation("ForumPostsAuthored", fields: [authorId], references: [id])

  @@index([threadId, createdAt])
}

generator client {
  provider = "prisma-client-js"
}

// Contatti del sito gestibili da admin
model SiteContact {
  id           Int      @id @default(autoincrement())
  name         String
  email        String?
  phone        String?
  whatsapp     String?
  telegram     String?
  languages    Json?
  role         String?
  notes        String?
  sectionKey   String
  sectionTitle String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([sectionKey])
}

// Avvisi (notifiche) configurati dall'utente
model UserAlert {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String // es: NEW_PHOTO, NEW_COMMENT, PROFILE_UPDATE, HAPPY_HOUR
  active    Boolean  @default(true)
  meta      Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, type])
}

// Avvisi città preferite per aggiornamenti
model CityAlert {
  id        Int      @id @default(autoincrement())
  userId    Int
  cities    Json // array di stringhe (nomi città)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId])
}

enum ReviewStatus {
  IN_REVIEW
  APPROVED
  REJECTED
}

model Review {
  id           Int          @id @default(autoincrement())
  authorId     Int
  targetUserId Int
  rating       Int
  title        String
  body         String
  status       ReviewStatus @default(IN_REVIEW)
  createdAt    DateTime     @default(now())

  author User @relation("ReviewsAuthored", fields: [authorId], references: [id])
  target User @relation("ReviewsReceived", fields: [targetUserId], references: [id])

  @@index([targetUserId, status, createdAt])
}

enum CommentStatus {
  IN_REVIEW
  APPROVED
  REJECTED
}

model Comment {
  id           Int           @id @default(autoincrement())
  authorId     Int
  targetUserId Int
  body         String
  status       CommentStatus @default(IN_REVIEW)
  createdAt    DateTime      @default(now())

  author User @relation("CommentsAuthored", fields: [authorId], references: [id])
  target User @relation("CommentsReceived", fields: [targetUserId], references: [id])

  @@index([targetUserId, status, createdAt])
}

enum ListingType {
  PHYSICAL
  VIRTUAL
}

enum ListingStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  REJECTED
  ARCHIVED
}

model Listing {
  id        Int           @id @default(autoincrement())
  userId    Int
  type      ListingType   @default(PHYSICAL)
  title     String
  city      String
  price     Int?
  status    ListingStatus @default(IN_REVIEW)
  createdAt DateTime      @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([city, status, type])
  @@index([userId, status])
}

enum Tier {
  STANDARD
  ARGENTO
  ORO
  TITANIO
  VIP
}

model AdminSettings {
  id                          Int      @id @default(autoincrement())
  creditValueCents            Int      @default(100) // default 1.00 EUR per credito
  currency                    String   @default("EUR")
  // New: pricing for placement per-day in credits, and allowed day range
  placementPricePerDayCredits Int      @default(10)
  placementMinDays            Int      @default(1)
  placementMaxDays            Int      @default(60)
  updatedAt                   DateTime @updatedAt
}

enum CreditTransactionType {
  PURCHASE
  SPEND
  REFUND
  ADJUST
}

model CreditWallet {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model CreditTransaction {
  id        Int                   @id @default(autoincrement())
  userId    Int
  amount    Int // positive for add, negative for spend
  type      CreditTransactionType
  reference String?
  meta      Json?
  createdAt DateTime              @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model CreditProduct {
  id                 Int      @id @default(autoincrement())
  code               String   @unique
  label              String
  creditsCost        Int
  durationDays       Int
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  // Optional: enable variable-duration purchase per package
  pricePerDayCredits Int?
  minDays            Int?
  maxDays            Int?
}

enum CreditOrderStatus {
  PENDING
  PAID
  FAILED
  CANCELED
}

model CreditOrder {
  id         Int               @id @default(autoincrement())
  userId     Int
  credits    Int // credits to purchase
  method     String // 'skrill' | 'manual_bonifico' | 'manual_bollettino'
  status     CreditOrderStatus @default(PENDING)
  phone      String? // reference phone for manual payments
  receiptUrl String? // uploaded receipt path
  meta       Json?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, status, createdAt])
}

enum EventType {
  VIEW
  CONTACT_CLICK
  SAVE
  BOOKING_CONFIRMED
}

enum QuickMeetingCategory {
  DONNA_CERCA_UOMO
  TRANS
  UOMO_CERCA_UOMO
  CENTRO_MASSAGGI
  GIGOLO
}

model QuickMeeting {
  id          Int                  @id @default(autoincrement())
  title       String
  description String?
  category    QuickMeetingCategory
  city        String
  zone        String?
  phone       String?
  whatsapp    String?
  telegram    String?
  age         Int?
  price       Int?
  photos      Json
  isActive    Boolean              @default(true)
  sourceUrl   String?
  sourceId    String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  publishedAt DateTime             @default(now())
  expiresAt   DateTime?

  // Collegamento a escort (null se importato da bot)
  userId Int?
  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Sistema di bump
  bumpPackage  String? // '1+1', '1+3', '1+7', '1x10', '1x3'
  bumpTimeSlot String? // '08:00-09:00', '09:00-10:00', etc.
  bumpCount    Int       @default(0)
  maxBumps     Int       @default(0)
  lastBumpAt   DateTime?
  nextBumpAt   DateTime?

  // Metadati
  views   Int @default(0)
  clicks  Int @default(0)
  reports Int @default(0)

  // Relazioni
  bumpLogs              BumpLog[]
  importedReviews       ImportedReview[]
  reviews               QuickMeetingReview[]
  quickMeetingPurchases QuickMeetingPurchase[]

  @@index([category])
  @@index([city])
  @@index([publishedAt(sort: Desc)])
  @@index([nextBumpAt])
  @@index([sourceId])
  @@index([userId])
}

model ImportedReview {
  id             Int       @id @default(autoincrement())
  escortName     String
  escortPhone    String?
  reviewerName   String?
  rating         Int? // 1-5 stelle
  reviewText     String?
  reviewDate     DateTime?
  sourceUrl      String?
  sourceId       String?   @unique
  isProcessed    Boolean   @default(false)
  matchedUserId  Int?
  quickMeetingId Int?
  createdAt      DateTime  @default(now())

  quickMeeting QuickMeeting? @relation(fields: [quickMeetingId], references: [id], onDelete: Cascade)

  @@index([escortPhone])
  @@index([sourceId])
  @@index([isProcessed])
  @@index([quickMeetingId])
}

model BumpLog {
  id             Int      @id @default(autoincrement())
  quickMeetingId Int
  bumpedAt       DateTime @default(now())
  timeSlot       String?
  success        Boolean  @default(true)
  error          String?

  quickMeeting QuickMeeting @relation(fields: [quickMeetingId], references: [id], onDelete: Cascade)

  @@index([quickMeetingId])
  @@index([bumpedAt(sort: Desc)])
}

model QuickMeetingReview {
  id             Int      @id @default(autoincrement())
  quickMeetingId Int
  userId         Int
  title          String
  rating         Int // 1-5 stelle
  reviewText     String
  createdAt      DateTime @default(now())
  isApproved     Boolean  @default(false)
  isVisible      Boolean  @default(true)

  quickMeeting QuickMeeting @relation(fields: [quickMeetingId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quickMeetingId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([isApproved])
}

model ProfileEvent {
  id        Int       @id @default(autoincrement())
  userId    Int
  type      EventType
  meta      Json?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, type, createdAt])
}

enum DocumentType {
  ID_CARD_FRONT
  ID_CARD_BACK
  SELFIE_WITH_ID
}

enum DocumentStatus {
  IN_REVIEW
  APPROVED
  REJECTED
}

model Document {
  id        Int            @id @default(autoincrement())
  userId    Int
  type      DocumentType
  status    DocumentStatus @default(IN_REVIEW)
  url       String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, status, createdAt])
}

model User {
  id           Int      @id @default(autoincrement())
  nome         String
  slug         String?  @unique
  email        String   @unique
  password     String
  ruolo        String
  suspended    Boolean  @default(false)
  profileViews Int      @default(0)
  createdAt    DateTime @default(now())

  // Relation: one user can have one escort profile
  escortProfile EscortProfile?

  // Relations: photos and bookings
  photos          Photo[]
  videos          Video[]
  bookingSettings BookingSettings?
  bookingRequests BookingRequest[]

  // Relation: one user can have one agency profile
  agencyProfile AgencyProfile?

  // Relation: an agency (User) can have many escort profiles linked
  agencyEscorts EscortProfile[] @relation("AgencyEscorts")

  // Analytics events
  events ProfileEvent[]

  // Credits relations
  creditWallet       CreditWallet?
  creditTransactions CreditTransaction[]
  creditOrders       CreditOrder[]

  // Reviews & Comments
  reviewsAuthored  Review[]  @relation("ReviewsAuthored")
  reviewsReceived  Review[]  @relation("ReviewsReceived")
  commentsAuthored Comment[] @relation("CommentsAuthored")
  commentsReceived Comment[] @relation("CommentsReceived")

  // Listings (Annunci)
  listings Listing[]

  // Documents (KYC)
  documents Document[]

  // Alerts
  userAlerts UserAlert[]
  cityAlerts CityAlert[]

  // Favorites
  favorites   Favorite[] @relation("UserFavorites")
  favoritedBy Favorite[] @relation("FavoriteTargets")

  // Forum authored content
  forumThreadsAuthored ForumThread[] @relation("ForumThreadsAuthored")
  forumPostsAuthored   ForumPost[]   @relation("ForumPostsAuthored")

  // Incontri Veloci
  quickMeetings         QuickMeeting[]
  quickMeetingReviews   QuickMeetingReview[]
  quickMeetingPurchases QuickMeetingPurchase[]
}

model EscortProfile {
  id                Int       @id @default(autoincrement())
  userId            Int       @unique
  agencyId          Int?
  bioIt             String?
  bioEn             String?
  languages         Json?
  cities            Json?
  services          Json?
  rates             Json?
  contacts          Json?
  tier              Tier      @default(STANDARD)
  tierExpiresAt     DateTime?
  girlOfTheDayDate  DateTime?
  consentAcceptedAt DateTime?
  updatedAt         DateTime  @updatedAt

  user   User  @relation(fields: [userId], references: [id])
  agency User? @relation("AgencyEscorts", fields: [agencyId], references: [id])

  @@index([agencyId])
}

enum PhotoStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  REJECTED
}

model Photo {
  id        Int         @id @default(autoincrement())
  userId    Int
  url       String
  name      String
  size      Int
  status    PhotoStatus @default(DRAFT)
  isFace    Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id])
}

enum VideoStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  REJECTED
}

model Video {
  id        Int         @id @default(autoincrement())
  userId    Int
  url       String // video file or external link
  thumb     String? // thumbnail URL
  title     String
  duration  String? // e.g. "00:30"
  hd        Boolean     @default(false)
  status    VideoStatus @default(DRAFT)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model BookingSettings {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique
  enabled          Boolean  @default(false)
  minNotice        String   @default("1 ora")
  allowedDurations Json
  prices           Json
  schedule         Json
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

enum BookingStatus {
  NEW
  ACCEPTED
  DECLINED
}

model BookingRequest {
  id        Int           @id @default(autoincrement())
  userId    Int
  name      String
  when      String
  duration  String
  note      String?
  status    BookingStatus @default(NEW)
  createdAt DateTime      @default(now())

  user User @relation(fields: [userId], references: [id])
}

model AgencyProfile {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  name        String?
  description String?
  languages   Json?
  cities      Json?
  services    Json?
  contacts    Json?
  website     String?
  socials     Json?
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Favorite {
  id           Int      @id @default(autoincrement())
  userId       Int
  targetUserId Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  targetUser User @relation("FavoriteTargets", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@unique([userId, targetUserId])
  @@index([userId])
  @@index([targetUserId])
}

model Visitor {
  id         Int      @id @default(autoincrement())
  sessionId  String
  targetType String // 'quickMeeting' | 'escortProfile'
  targetId   String
  createdAt  DateTime @default(now())

  @@unique([sessionId, targetType, targetId])
  @@index([targetType, targetId])
}

// ==============================
// Quick Meeting Packages (NEW)
// ==============================

model QuickMeetingProduct {
  id                Int      @id @default(autoincrement())
  code              String   @unique
  label             String
  type              String // 'DAY' | 'NIGHT'
  quantityPerWindow Int // 1 per DAY, 10 per NIGHT
  durationDays      Int // 1, 3, 7, ...
  creditsCost       Int
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  purchases QuickMeetingPurchase[]

  @@index([active])
  @@index([type])
}

model QuickMeetingPurchase {
  id        Int      @id @default(autoincrement())
  userId    Int
  meetingId Int
  productId Int
  status    String   @default("ACTIVE") // ACTIVE | EXPIRED | CANCELED
  startedAt DateTime @default(now())
  expiresAt DateTime
  createdAt DateTime @default(now())

  user         User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      QuickMeetingProduct        @relation(fields: [productId], references: [id])
  quickMeeting QuickMeeting               @relation(fields: [meetingId], references: [id])
  schedules    QuickMeetingBumpSchedule[]

  @@index([userId])
  @@index([meetingId])
  @@index([productId])
  @@index([status])
  @@index([expiresAt])
}

model QuickMeetingBumpSchedule {
  id         Int       @id @default(autoincrement())
  purchaseId Int
  window     String // 'DAY' | 'NIGHT'
  runAt      DateTime // quando va eseguita la risalita
  executedAt DateTime?
  status     String    @default("PENDING") // PENDING | DONE | SKIPPED

  purchase QuickMeetingPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([status])
  @@index([runAt])
}

// ==============================
// Street Fireflies (mappa speciale gestita solo da admin)
// ==============================

model StreetEscort {
  id               Int      @id @default(autoincrement())
  name             String
  city             String
  lat              Float?
  lon              Float?
  // Categoria per icone mappa: ESCORT | TRANS | COPPIE
  category         String   @default("ESCORT")
  shortDescription String?
  fullDescription  String?
  price            Int?
  active           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  photos StreetEscortPhoto[]

  @@index([city, active])
}

model StreetEscortPhoto {
  id             Int      @id @default(autoincrement())
  streetEscortId Int
  url            String
  isCensored     Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  streetEscort StreetEscort @relation(fields: [streetEscortId], references: [id], onDelete: Cascade)

  @@index([streetEscortId])
}

